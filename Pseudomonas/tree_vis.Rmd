---
title: "R Notebook"
output: html_notebook
---
Load the trees
```{R}
closeAllConnections()
rm(list=ls())
library(phytools)
library(ggtree)
library(ggpubr)

tr_files<- list('nuc'= '/home/thkuo/bifo-sgi/TreePaper/Paeru.v4/results/raxml/RAxML_bipartitions.nuc.bs',
                'cd'= '/home/thkuo/bifo-sgi/TreePaper/Paeru.v4/results/cd/cutoff.v1/RAxML_bipartitions.conc.bs')
trs<- lapply(tr_files, function(f) read.newick(f))

source('/home/thkuo/projects/TreePaper/bin/collapse_branches.R')
cutoff<- list(br= 5e-4, bs= 60)
outgroup<- c('CH4433')
col_trs<- list()
for (x in names(trs)){
    tr<- trs[[x]]
    # reroot
    tr<- phytools::reroot(tr, node.number = which(tr$tip.label == outgroup[1]), position = 1e-6)
    trs[[x]]<- tr
    # collapse
    short_ix<- find_short_branches(tr, br_cutoff = cutoff$br)
    low_ix<- find_low_branches(tr, bs_cutoff = cutoff$bs)
    col_tr<- collapse_branches(tr= tr, target_nodes = union(short_ix, low_ix))
    col_tr<- phytools::reroot(col_tr, node.number = which(col_tr$tip.label == outgroup[1]), position = 1e-6)
    col_trs[[x]]<- col_tr
}
sapply(col_trs, function(t) Nnode(t))
sapply(col_trs, function(t) quantile(t$edge.length))
```
Visualize multifurcations
```{R}
library(ggplot2)
count_multifurcating_nodes<- function(tr){
    offsprint_counts<- table(tr$edge[,1])
    is_multi<- names(offsprint_counts[offsprint_counts > 2])
    is_multi_not_root<- is_multi[as.integer(is_multi) > (Ntip(tr)+1) ]
    is_multi_not_root
}
multi_ixs<- list()
tr_p_list<- list()
for (x in names(col_trs)){
    t<- col_trs[[x]]
    multi_n<- count_multifurcating_nodes(t)
    multi_ixs[[x]]<- multi_n
    # tr_p_list[[x]]<- ggtree(t, branch.length = 'none')+
    #     geom_nodepoint(aes(subset= not (node %in% multi_n)), color= '#0AA614', alpha= .4)+
    #     geom_treescale(x = 0, y= -10, offset = -10, width = 0.1)
    # visualiye the multifurcating nodes
    tr_p_list[[x]]<- ggtree(t)+
        geom_nodepoint(aes(subset= node %in% multi_n), alpha= 0.5, color= 'red')+
        geom_tiplab(aes(label=label, subset= label %in% outgroup))+
        geom_treescale(x = 0, y= -10, offset = -10, width = 0.1)
}
sapply(multi_ixs, function(l) length(l))
ggarrange(plotlist = tr_p_list, ncol=2, labels= names(tr_p_list))
# ggsave('multifurcating_nodes.pdf')
```
Visualize the sampling origins
```{R}
library(RColorBrewer)
library(ggsci)
source('load_biological_data.R')
bio_df<- load_biological_data()
bio_list<- as.list(bio_df)
for (n in 1:length(bio_list)){
    names(bio_list[[n]])<- rownames(bio_df)
}
traits<- c()
loc_id<- c('CH', 'F', 'M')
names(loc_id)<- c('Berlin', 'Frankfurt', 'Hanover')
traits<- loc_id[
    bio_list$`Geographic Origin`[col_trs$nuc$tip.label]]
names(traits)<- col_trs$nuc$tip.label
traits<- factor(traits, levels= c('CH', 'F', 'M'))
loc_tr_p_list<- list()
for (x in names(col_trs)){
    loc_tr_p_list[[x]]<- ggtree(col_trs[[x]], layout = 'circular', branch.length = 'none')+
        geom_tippoint(aes(color= traits[label]))+
        # geom_tiplab2(aes(subset= label %in% outgroup, label= label ) )+
        scale_color_jama(name= 'origin')+
        theme(legend.position = 'bottom')
}

ggarrange(plotlist = loc_tr_p_list, ncol=2, common.legend = T, legend = 'bottom', labels = names(loc_tr_p_list))
ggsave('cladogram_clinics.pdf')
```
Visualize MLST
```{R}
library(ggsci)
source('load_mlst.R')
mlst_df<- load_mlst()
mlst_dict<- mlst_df[match(col_trs$nuc$tip.label, mlst_df[, 'Isolate']), 'group_id']
names(mlst_dict)<- col_trs$nuc$tip.label
# focus on the bigger ones
mlst_counts<- table(mlst_dict)
# target_mlsts<- names(mlst_counts[order(-mlst_counts)][1:5])
target_mlsts<- names(mlst_counts[mlst_counts > 5])
mlst_dict<- mlst_dict[mlst_dict %in% target_mlsts]
for (x in names(col_trs)){
    loc_tr_p_list[[x]]<- ggtree(col_trs[[x]], layout = 'circular', branch.length = 'none')+
        geom_tippoint(aes(color= mlst_dict[label]))+
        scale_color_d3(name= 'mlst')+
        theme(legend.position = 'bottom')
}

ggarrange(plotlist = loc_tr_p_list, ncol=2, common.legend = T, legend = 'bottom', labels = names(loc_tr_p_list))
# ggsave('cladogram_mlst.pdf')
```